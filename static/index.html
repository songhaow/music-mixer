<!DOCTYPE html>
<html lang = "en">

  <head>
    <meta charset="utf-8utf-8">
    <title>songtrack_backend.js</title>

    <style>
    .grid-container {
      display: flex;
      justify-content: center;
      border-radius: 10px;
      width: 1100px;
      margin-left: auto;
      margin-right: auto;
      text-align: center;
      display: grid;
      grid-template-columns: auto 280px 280px 280px;
      grid-gap: 5px;
      background-color: rgb(96,125,139);
      padding: 5px;
    }

    .playbox{
      flex:none;
      border-radius: 5px;
      width: 250px;
      margin: 5px;
      padding-left: 10px;
      padding-bottom: 5px;
      padding-top: 5px;
      display: inline-block;
      vertical-align: top;
      background: linear-gradient(white, rgb(50,50,50));
      font-size: 20px;
    }

    .myImg{
      flex:none;
      width:100px;
      border-radius: 5px;
      padding-top: 5px;
      background: linear-gradient( white,rgb(50,50,50));
    }

    .div03{
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 5px;
      text-align: center;
      border-radius: 10px;
      width: 1100px;
      margin-left: auto;
      margin-right: auto;
      background-color: rgb(50,100,120);
      margin-bottom: 5px;
    }

    .inputbox{
      flex:none;
      border-radius: 5px;
      width: 500px;
      margin: 5px;
      padding-left: 30px;
      padding-bottom: 5px;
      padding-top: 5px;
      display: inline-block;
      vertical-align: center;
      background: linear-gradient(white, rgb(50,50,50));
      font-size: 20px;
    }

    #freq_graph{
      align-items: center;
      padding: 5px;
      text-align: center;
      width: 800px;
      height: 160px;
      background-color: #002D3C;
      margin: auto;
    }

    #analyser_render{
      align-items: center;
      padding: 5px;
      text-align: center;
      width: 700px;
      height: 90px;
      background: linear-gradient(white, rgb(50,50,50));
      margin: auto;
    }
    </style>

    <link rel="stylesheet" href="../static/css/build-music-visualizer.css">

		<script>
		   window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
		   ga('create', 'UA-15976986-14', 'auto');
		   ga('send', 'pageview');
		</script>
    <script src = "../static/js/build-music-visualizer/jquery.min.js"></script>
		<script src = "../static/js/build-music-visualizer/build-music-visualizer-web-audio-api.js"></script>
		<script src = "../static/js/build-music-visualizer/build-music-visualizer-render.js"></script>
		<script src = "../static/js/build-music-visualizer/build-music-visualizer-web-audio.js"></script>
    <link rel="stylesheet" type="text/css" href="static/css/tracks-sw.css">
    <script type="text/javascript" src="static/js/vendor/d3.v4.js"></script>
    <div class = "head" title="Music mixer">Music - Mixer</div>
  </head>

  <body>

    <div class = 'box00' >
      <div class = "div01">
        <!-- <div class = "divd3" id="chartForTrack"></div> -->
        <svg width="1360" height="365" style="border: 1px solid black;" padding = "10px" margin = '10px'></svg>
      </div>
      <hr>

      <div class="grid-container">
        <div class="myImg">
          <img id="myImg" src="static/source_audio/music-01.png" height="35">
        </div>
        <div class = "playbox">
          <button id='play1Button' title="Play track1"> Play track1 </button>
          <button id='pause1Button' title="Pause track1"> Pause track1 </button>
        </div>
        <div class = "playbox">
          <button id='play2Button'> Play track2 </button>
          <button id='pause2Button'> Pause track2 </button>
        </div>
        <div class = "playbox">
          <button id='playMixButton'>Play mix</button>
          <button id='pauseMixButton'>Pause mix</button>
        </div>
      </div>
      <br>

      <div class = "div03">
          <div class = "inputbox">
            Load track01: <input id = "fname01" type="file" accept="mp3/m4a"></input>
          </div>
          <div class = "inputbox">
            Load track2: <input id = "fname02" type="file" accept="mp3/m4a"></input>
          </div>
      </div>

      <div id = "freq_graph">
         <canvas id = "analyser_render"></canvas>
         <div id = "audio_box">
           <audio controls></audio>
           <input type="range" min="0" max="100" value="50" oninput="sample.changeVolume(this);">
         </div>
      </div>
    </div>



    <div id="container">
      <article>
        <p>
          <canvas id="fragment"></canvas>
        </p>

        <p>
          <button class="song-btn">Play Song</button>
        </p>

        <div class="sourceCode" id="vertex-shader">
          <script>
            attribute vec2 position;
            void main(void) {
              gl_Position = vec4(position, 0, 1);
            }
          </script>
        </div>

        <div class="sourceCode" id="fragment-shader">
          <script>
            precision mediump float;
            uniform float time;
            uniform vec2 resolution;
            uniform sampler2D spectrum;

            void main(void) {
              vec3 c;
              float z = 0.1 * time;
              vec2 uv = gl_FragCoord.xy / resolution;
              vec2 p = uv - 0.5;
              p.x *= resolution.x / resolution.y;
              float l = 0.2 * length(p);
              for (int i = 0; i < 3; i++) {
                z += 0.07;
                uv += p / l * (sin(z) + 1.0) * abs(sin(l * 9.0 - z * 2.0));
                c[i] = 0.01 / length(abs(mod(uv, 1.0) - 0.5));
              }
              float intensity = texture2D(spectrum, vec2(l, 0.5)).x;
              gl_FragColor = vec4(c / l * intensity, time);
            }
          </script>
        </div>

    <pre class="sourceCode javascript">
      <code class="sourceCode javascript">
        <span class="kw">const</span> analyser
        <span class="op">=</span>
        <span class="va">audioContext</span>.
        <span class="at">createAnalyser</span>()
        <span class="va">masterGain</span>.
        <span class="at">connect</span>(analyser)
        <span class="kw">const</span> waveform
        <span class="op">=</span>
        <span class="kw">new</span>
        <span class="at">Float32Array</span>(
        <span class="va">analyser</span>.
        <span class="at">frequencyBinCount</span>)
        <span class="va">analyser</span>.
        <span class="at">getFloatTimeDomainData</span>(waveform)
     </code>
    </pre>
    <!-- <script> // the replace js code for above section
      const analyser = audioContext.createAnalyser();
      masterGain.connect(analyser);
      const waveform = new Float32Array(analyser.frequencyBinCount);
      analyser.getFloatTimeDomainData(waveform);
    </script> -->

    <!-- <script> // the replace js code for all
        const analyser = audioContext.createAnalyser();
        masterGain.connect(analyser);
        const waveform = new Float32Array(analyser.frequencyBinCount);
        analyser.getFloatTimeDomainData(waveform);
      const spectrum = new Uint8Array(analyser.frequencyBinCount);
      function updateSpectrum() {
        requestAnimationFrame(updateSpectrum);
        analyser.getByteFrequencyData(spectrum);
      }


      const fragCanvas = document.getElementById('fragment');
      fragCanvas.width = fragCanvas.parentNode.offsetWidth;
      fragCanvas.height = fragCanvas.width * 0.75;
      const gl = fragCanvas.getContext('webgl') || fragCanvas.getContext('experimental-webgl');
      const vertexShaderSrc = document.getElementById('vertex-shader').textContent;
      const fragmentShaderSrc = document.getElementById('fragment-shader').textContent;
      const fragShader = createShader(gl, vertexShaderSrc, fragmentShaderSrc);


      const fragPosition = gl.getAttribLocation(fragShader, 'position');
      gl.enableVertexAttribArray(fragPosition);
      const fragTime = gl.getUniformLocation(fragShader, 'time');
      gl.uniform1f(fragTime, audioContext.currentTime);
      const fragResolution = gl.getUniformLocation(fragShader, 'resolution');
      gl.uniform2f(fragResolution, fragCanvas.width, fragCanvas.height);
      const fragSpectrumArray = new Uint8Array(4 * spectrum.length);
      const fragSpectrum = createTexture(gl);


      initQuad(gl);
      function renderFragment() {
        requestAnimationFrame(renderFragment);
        gl.uniform1f(fragTime, audioContext.currentTime);
        copyAudioDataToTexture(gl, spectrum, fragSpectrumArray);
        renderQuad(gl)
      }
    </script> -->

    <pre class="sourceCode javascript">
      <code class="sourceCode javascript">
        <span class="kw">const</span> spectrum
        <span class="op">=</span>
        <span class="kw">new</span>
        <span class="at">Uint8Array</span>(
        <span class="va">analyser</span>.
        <span class="at">frequencyBinCount</span>)
        <span class="op">;</span>(
        <span class="kw">function</span>
        <span class="at">updateSpectrum</span>()
        <span class="op">{</span>
        <span class="at">requestAnimationFrame</span>(updateSpectrum)
        <span class="va">analyser</span>.
        <span class="at">getByteFrequencyData</span>(spectrum)
        <span class="op">}</span>)()
      </code>
    </pre>
    <!-- <script> // the replace js code for above section
      const spectrum = new Uint8Array(analyser.frequencyBinCount);
      function updateSpectrum() {
        requestAnimationFrame(updateSpectrum);
        analyser.getByteFrequencyData(spectrum);
      }
    </script> -->

    <pre class="sourceCode javascript">
      <code class="sourceCode javascript">
        <span class="kw">const</span> fragCanvas
        <span class="op">=</span>
        <span class="va">document</span>.
        <span class="at">getElementById</span>(
        <span class="st">'fragment'</span>)
        <span class="va">fragCanvas</span>.
        <span class="at">width</span>
        <span class="op">=</span>
        <span class="va">fragCanvas</span>.
        <span class="va">parentNode</span>.
        <span class="at">offsetWidth</span>
        <span class="va">fragCanvas</span>.
        <span class="at">height</span>
        <span class="op">=</span>
        <span class="va">fragCanvas</span>.
        <span class="at">width</span>
        <span class="op">*</span>
        <span class="fl">0.75</span>
        <span class="kw">const</span> gl
        <span class="op">=</span>
        <span class="va">fragCanvas</span>.
        <span class="at">getContext</span>(
        <span class="st">'webgl'</span>)
        <span class="op">||</span>
        <span class="va">fragCanvas</span>.
        <span class="at">getContext</span>(
        <span class="st">'experimental-webgl'</span>)
        <span class="kw">const</span> vertexShaderSrc
        <span class="op">=</span>
        <span class="va">document</span>.
        <span class="at">getElementById</span>(
        <span class="st">'vertex-shader'</span>).
        <span class="at">textContent</span>
        <span class="kw">const</span> fragmentShaderSrc
        <span class="op">=</span> <span class="va">document</span>.
        <span class="at">getElementById</span>(
        <span class="st">'fragment-shader'</span>).
        <span class="at">textContent</span>
        <span class="kw">const</span> fragShader
        <span class="op">=</span> <span class="at">createShader</span>(gl
        <span class="op">,</span> vertexShaderSrc<span class="op">,
        </span> fragmentShaderSrc)
      </code>
    </pre>
    <!-- <script> // the replace js code for above section
      const fragCanvas = document.getElementById('fragment')
      fragCanvas.width = fragCanvas.parentNode.offsetWidth
      fragCanvas.height = fragCanvas.width * 0.75
      const gl = fragCanvas.getContext('webgl') || fragCanvas.getContext('experimental-webgl')
      const vertexShaderSrc = document.getElementById('vertex-shader').textContent
      const fragmentShaderSrc = document.getElementById('fragment-shader').textContent
      const fragShader = createShader(gl, vertexShaderSrc, fragmentShaderSrc)
    </script> -->


    <pre class="sourceCode javascript">
      <code class="sourceCode javascript">
        <span class="kw">const</span> fragPosition
        <span class="op">=</span>
        <span class="va">gl</span>.
        <span class="at">getAttribLocation</span>(fragShader
        <span class="op">,</span>
        <span class="st">'position'</span>)
        <span class="va">gl</span>.
        <span class="at">enableVertexAttribArray</span>(fragPosition)
        <span class="kw">const</span> fragTime
        <span class="op">=</span>
        <span class="va">gl</span>.
        <span class="at">getUniformLocation</span>(fragShader
        <span class="op">,</span>
        <span class="st">'time'</span>)
        <span class="va">gl</span>.
        <span class="at">uniform1f</span>(fragTime
        <span class="op">,</span>
        <span class="va">audioContext</span>.
        <span class="at">currentTime</span>)
        <span class="kw">const</span> fragResolution
        <span class="op">=</span>
        <span class="va">gl</span>.
        <span class="at">getUniformLocation</span>(fragShader
        <span class="op">,</span>
        <span class="st">'resolution'</span>)
        <span class="va">gl</span>.
        <span class="at">uniform2f</span>(fragResolution
        <span class="op">,</span>
        <span class="va">fragCanvas</span>.
        <span class="at">width</span>
        <span class="op">,</span>
        <span class="va">fragCanvas</span>.
        <span class="at">height</span>)
        <span class="kw">const</span> fragSpectrumArray
        <span class="op">=</span>
        <span class="kw">new</span>
        <span class="at">Uint8Array</span>(
        <span class="dv">4</span>
        <span class="op">*</span>
        <span class="va">spectrum</span>.
        <span class="at">length</span>)
        <span class="kw">const</span> fragSpectrum
        <span class="op">=</span>
        <span class="at">createTexture</span>(gl)
      </code>
    </pre>
    <!-- <script>  // the replace js code for above section
      const fragPosition = gl.getAttribLocation(fragShader, 'position');
      gl.enableVertexAttribArray(fragPosition);
      const fragTime = gl.getUniformLocation(fragShader, 'time');
      gl.uniform1f(fragTime, audioContext.currentTime);
      const fragResolution = gl.getUniformLocation(fragShader, 'resolution');
      gl.uniform2f(fragResolution, fragCanvas.width, fragCanvas.height);
      const fragSpectrumArray = new Uint8Array(4 * spectrum.length);
      const fragSpectrum = createTexture(gl);
    </script> -->

    <pre class="sourceCode javascript">
      <code class="sourceCode javascript">
        <span class="at">initQuad</span>(gl)
        <span class="op">;</span>(
        <span class="kw">function</span>
        <span class="at">renderFragment</span>()
        <span class="op">{</span>
        <span class="at">requestAnimationFrame</span>(renderFragment)
        <span class="va">gl</span>.
        <span class="at">uniform1f</span>(fragTime
        <span class="op">,</span>
        <span class="va">audioContext</span>.
        <span class="at">currentTime</span>)
        <span class="at">copyAudioDataToTexture</span>(gl
        <span class="op">,</span> spectrum
        <span class="op">,</span> fragSpectrumArray)
        <span class="at">renderQuad</span>(gl)
        <span class="op">}</span>)()
      </code>
    </pre>
    <!-- <script> // the replace js code for above section -->
      <!-- initQuad(gl);
      function renderFragment() {
        requestAnimationFrame(renderFragment);
        gl.uniform1f(fragTime, audioContext.currentTime);
        copyAudioDataToTexture(gl, spectrum, fragSpectrumArray);
        renderQuad(gl)
      } -->
    <!-- </script> -->

    </article>
    </div>

    <!-- <div class = "div02">
      <div class = "box">
        <h5>Regular play Song1: 02-SW-062018.mp3</h5>
        <audio id="track5" src="static/source_audio/02-SW-062018.mp3" type="audio/mpeg" controls></audio>
      </div>
      <div class = "box">
        <h5>Regular play Song2: 07-Littlewhiteboat.mp3</h5>
        <audio id="track6" src="static/source_audio/07-Littlewhiteboat.mp3" type="audio/mpeg" controls></audio>
      </div>
    </div> -->

  </body>

  <!-- <script>
  canvas = document.getElementById('analyser_render');
  console.log('canvas width&height: ', canvas.width, canvas.height);
  ctx = canvas.getContext('2d');
  ctx.fillStyle = "rgb(200,0,200)";
  ctx.fillRect(10,10,30,30);
  </script> -->

  <script src="static/js/main.js" type="module"></script>
  <!-- https://www.npmjs.com/package/music-tempo -->
  <script src="static/js/music-tempo.min.js"></script>

</html>
